default_platform(:android)

platform :android do
  desc "Update version name, increment version code, and build signed release"
  lane :release do |options|
    android_set_version_name(
      gradle_file: "app/build.gradle.kts",
      version_name: options[:version]
    )
    android_set_version_code(gradle_file: "app/build.gradle.kts")

    keystore_path = File.expand_path(ENV["KEYSTORE_PATH"] || "app/keystore.jks", Dir.pwd)
    UI.message("ðŸ”‘ Using keystore path: #{keystore_path}")
    unless File.exist?(keystore_path)
      UI.user_error!("Keystore not found at #{keystore_path}. Make sure itâ€™s decoded correctly in CI.")
    end

    gradle(
      task: "assemble",
      build_type: "Release",
      properties: {
        "KEYSTORE_PATH" => keystore_path,
        "KEYSTORE_PASSWORD" => ENV["KEYSTORE_PASSWORD"],
        "KEY_ALIAS" => ENV["KEY_ALIAS"],
        "KEY_PASSWORD" => ENV["KEY_PASSWORD"]
      }
    )
  end

  desc "Distribute the release build to Firebase"
  lane :firebase do |options|
    release_notes = ENV["RELEASE_NOTES"] || options[:notes] || "Automated release via semantic-release"
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"],
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
      release_notes: release_notes,
      android_artifact_path: "app/build/outputs/apk/release/app-release.apk"
    )
  end
end
